# 테스트 더블

## mock

- 특정 메서드가 몇 번 호출되었고, 어떤 파라미터로 호출되었는지 검증할 때 사용하는 가짜 객체

- 테스트 대상의 의존성을 mock으로 대체해서 테스트 진행

- 가짜 객체이기 때문에 실제 로직은 작동하지 않음

- ```java
  @ExtendWith(MockitoExtension.class)
  class UserServiceTest {
  
    @Mock
    UserRepository userRepository;
    @InjectMocks
    UserService userService;
  
    @Test
    @DisplayName("user 생성")
    void createUser() {
      //given
      String email = "test@test.com";
    	String username = "username";
    	String password = "password";
      UserCreateRequest userCreateRequest = new UserCreateRequest(email, username, password);
      User user = User.create(username, email, password);
  
      when(userRepository.save(any(User.class))).thenReturn(user);
  
      //when
      UserResponse response = userService.createUser(userCreateRequest);
  
      verify(userRepository).save(any(User.class));
    }
  ```

- UserService의 외부 의존성인 UserRepository를 mocking하고, save() 메소드가 호출되었는지 테스트함

## stub

- 특정 메서드가 미리 정해진 값만을 호출하도록 할 때 사용

- 보통 mock과 같이 사용되며 외부 의존성의 반환값을 고정하고자 할 때 사용

- mockito에서 when() 으로 구현

- ```java
  @ExtendWith(MockitoExtension.class)
  class UserServiceTest {
  
    @Mock
    UserRepository userRepository;
    @InjectMocks
    UserService userService;
  
    @Test
    @DisplayName("user 생성")
    void createUser() {
      //given
      String email = "test@test.com";
    	String username = "username";
    	String password = "password";
      UserCreateRequest userCreateRequest = new UserCreateRequest(email, username, password);
      User user = User.create(username, email, password);
  
      when(userRepository.save(any(User.class))).thenReturn(user);
  
      //when
      UserResponse response = userService.createUser(userCreateRequest);
  
      verify(userRepository).save(any(User.class));
    }
  ```

- 위와 같은 예시로, UserRepository를 mock으로 설정

- when()을 통해 stubbing하고 thenReturn() 으로 정해진 반환값을 지정함

## spy

- mock과 같은 기능을 하지만 실제 로직을 수행한다는 점이 차이점
- 실제 객체를 사용하기 때문에 그 동작을 그대로 수행함
- 필요한 메서드 호출만 stubbing 하고, 나머지 메서드는 실제 로직을 사용하고자 할 때 사용함
- ```java
  @ExtendWith(MockitoExtension.class)
  class MessageServiceTest {
  
    @Mock
    MessageRepository messageRepository;
    @Spy
    PageResponseMapper pageResponseMapper;
    @InjectMocks
    MessageService messageService;
  
    @Test
    @DisplayName("message 조회")
    void readMessage() {
      UUID channelId = UUID.randomUUID();
      Pageable pageable = PageRequest.of(0, 10);
      Instant createdAt = Instant.now();
      MessageResponse messageResponse = new MessageResponse(
          UUID.randomUUID(),
          createdAt,
          createdAt,
          "message",
          mock(UserResponse.class),
          channelId,
          List.of()
      );
  
      when(messageRepository.findPageByChannelId(channelId, pageable))
          .thenReturn(new SliceImpl<>(List.of(mock(Message.class)), pageable, false));
  
      PageResponse<MessageResponse> pageResponse =
          messageService.readAllByChannelId(channelId, pageable);
  
      assertThat(pageResponse.content().get(0)).isEqualTo(messageResponse);
      assertThat(pageResponse.size()).isEqualTo(pageable.getPageSize());
      assertThat(pageResponse.hasNext()).isFalse();
      assertThat(pageResponse.nextCursor()).isEqualTo(createdAt);
      assertThat(pageResponse.totalElements()).isNull();
    }
  }
  ```
- DTO 변환을 담당하는 PageResponseMapper는 spy로 설정해서 실제 변환 로직을 그대로 수행하게 함

