# TCP/IP 4계층 모델

## 계층 구조

TCP/IP 4계층

- 어플리케이션 계층
- 전송 계층
- 인터넷 계층
- 링크 계층

OSI 7계층

- 어플리케이션 계층
- 프레전테이션 계층
- 세션 계층
- 전송 계층
- 네트워크 계층
- 데이터 링크 계층
- 물리 계층

TCP/IP 4계층은 OSI의 상위 3계층을 어플리케이션 계층으로, 하위 2계층을 링크 계층으로 통합해서 처리한다. 또한 네트워크 계층을 인터넷 계층으로 표현하는 점이 다르다.

각각의 계층들은 서로 독립적이기 때문에, 다른 계층이 변경되어도 서로 영향을 받지 않도록 설계되었다.

### 어플리케이션 계층

어플리케이션 계층은 응용 프로그램이 사용되는 계층이며 웹, 이메일 등의 실질적인 서비스를 제공하는 계층이다.

- HTTP
  - 웹 통신에 사용되는 프로토콜
- FTP
  - 파일 전송에 사용되는 프로토콜
- SSH
  - 네트워크를 통해 원격 컴퓨터에 안전하게 접속하기 위한 프로토콜
- SMTP
  - 이메일을 전송하기 위한 프로토콜
- DNS
  - ip 주소와 도메인 이름을 매핑해주는 프로토콜

### 전송 계층

전송 계층은 송신자와 수신자를 연결하는 통신 서비스를 제공한다. 대표적으로 TCP와 UDP가 존재한다

#### TCP

TCP는 신뢰성있는 연결을 제공하는 프로토콜이다. 

3-way-handshake는 TCP가 신뢰성을 제공하는 방법이다. 과정은 다음과 같다

- 클라이언트는 접속하려는 서버에 임의의 isn 값을 seq에 넣고 syn 플래그를 1로 설정해 패킷을 보낸다(syn)
- syn 패킷을 받은 서버는 임의의 isn 값을 seq로 하고, 클라이언트가 보낸 seq 값에 1을 더한 값을 ack로 보낸다(syn + ack)
- 클라이언트는 서버의 seq값에 1을 더한 값을 ack로 보낸다. (ack)

4-way-handshake는 연결을 종료할 때 필요한 과정이다.

- 클라이언트가 fin 패킷을 전송한다. 이후 클라이언트는 fin_wait_1 상태로 변해 응답을 대기한다
- 서버가 패킷을 받으면 응답으로 ack 패킷을 전송한다. 이때 서버는 close_wait 상태로 대기한다
- 서버는 fin 패킷을 클라이언트에게 전송하고 lask_ack 상태로 변한다
- 클라이언트는 서버의 ack를 받은 후 fin_wait_2 상태로 대기하다가 fin 패킷을 받으면 서버에게 ack를 보내고 time_wait 상태로 일정 시간 대기 후에 연결을 종료한다.
- 서버가 마지막으로 ack를 받으면 연결이 종료된다.

클라이언트가 time_wait 상태로 대기하는 이유는 지연 패킷이 발생했을 경우를 대비하기 위해서이다. fin 패킷 이전에 생성된 패킷이 fin 패킷 이후에 도착한다면 데이터의 유실이 발생할 수 있고 데이터 무결성이 깨질 가능성이 존재한다. 또한 서버 측이 last_ack인 상태에서 클라이언트가 연결을 닫게 된다면 새 연결을 시도할 때 last_ack 상태이기 때문에 연결에 오류가 발생할 수도 있다. 따라서 time_wait 상태로 일정 시간 대기한 후에 연결을 종료하도록 해야 문제가 발생하지 않는다.

### 인터넷 계층

인터넷 계층은 패킷을 ip 주소로 지정된 목적지로 전송하기 위해서 사용하는 계층이다. IP, ARP, ICMP 등의 프로토콜이 존재한다. 상대방이 잘 받았는지에 대한 여부는 상위 계층인 전송 계층에서 담당하며 인터넷 계층에서는 이것을 보장하지 않는다

### 링크 계층

링크 계층은 실질적으로 데이터를 전달하며 장치 간에 신호를 주고받는 규칙을 정하는 계층이다. OSI 7계층에서의 물리 계층은 0과 1의 데이터를 직접 보내는 계층이며, 데이터 링크 계층은 이더넷 프레임을 통해 에러 확인, 흐름 제어, 접근 제어 등을 담당하는 계층이다.

#### 유선

유선 LAN은 이더넷 프로토콜을 따르며 전이중화 통신을 사용한다.

전이중화 통신은 양쪽 장치가 동시에 송수신 할 수 있는 통신 방식이다. 송신용 링크와 수신용 링크를 나누어 동시에 데이터를 주고 받을 수 있다.

과거에는 CSMA/CD를 사용한 반이중화 방식으로 통신했다. CSMA/CD는 데이터를 보낼 때 충돌이 발생하는것이 감지되면 일정 시간 대기 후에 재전송하는 방식이다.

케이블로는 트위스트 페어 케이블과 광섬유 케이블을 사용한다.

- 트위스트 페어 케이블
  - 8개의 구리선을 꼬아 묶은 케이블
  - UTP: 구리선을 실드 처리하지 않은 케이블. 흔히 부르는 LAN 케이블이 이 케이블이다.
  - STP: 구리선을 실드 처리한 케이블
- 광섬유 케이블
  - 광섬유를 이용해서 만든 케이블
  - 빛을 이용하기 때문에 구리선보다 더 먼거리를 훨씬 빠르게 전송할 수 있다.

#### 무선

무선 LAN은 수신과 송신에 같은 채널을 사용하기 때문에 반이중화 방식을 사용해서 통신한다.

반이중화 통신은 양쪽 장치가 동시에 송수신할 수 없고 송신 또는 수신만 가능한 통신 방법이다. 무선인 경우 CDMA/CA를 사용한다. CDMA/CA는 CDMA/CD와 다르게 충돌을 감지하는 것이 아닌 충돌을 피하는 방식을 사용한다. 과정은 다음과 같다.

- 사용중인 채널이 있으면 유휴 상태인 다른 채널을 찾는다
- 프레임간 공간 시간인 IFS 시간만큼 기다린다. IFS는 프레임의 우선 순위를 정의할 때도 사용된다.
- 프레임을 보내기 전에 0 ~ 2^k - 1의 랜덤 상수를 기반으로 결정된 시간만큼 대기한 후 프레임을 전송한다
  - 잘 송신이 되었고 ack를 받았으면 전송 종료
  - 송신이 되지 않았다면 k + 1을 반복하며 송신을 계속 시도한다. k가 최대값보다 커진다면 abort한다.

무선 랜은 공기에 주파수를 쏘아서 무선 통신망을 구축한다. 주파수 대역은 2.4GHz와 5Ghz가 있다. 2.4GHz는 장애물에 영향을 상대적으로 덜 받지만 다른 전파와 간섭이 일어나는 경우가 많다. 5GHz는 사용할 수 있는 채널이 많고 동시에 사용할 수 있기 때문에 상대적으로 깨끗한 전파 환경을 구축할 수 있다.

와이파이는 무선 랜 신호에 연결할 수 있게 하는 기술로 접속하려면 무선 AP장치가 필요하다. 이를 흔히 공유기라고 하며 유선 신호를 무선 신호로 바꿔서 무선으로 인터넷에 접속할 수 있게 해준다.

#### 이더넷 프레임

데이터 링크 계층은 이더넷 프레임을 통해 전달받은 데이터의 에러를 검출하고 캡슐화 하며 다음과 같은 구조를 가진다.

- Preamble
  - 이더넷 프레임이 시작됨을 알림
- SFD
  - 다음 바이트부터 MAC 주소 필드가 시작됨을 알림
- DMAC, SMAC
  - 송신, 수신 MAC 주소
- EtherType
  - 상위 계층인 IP 프로토콜을 정의함. (IPv4, IPv6)
- Payload
  - 전달받은 데이터
- CRC
  - 에러 확인 비트

### 계층 간 데이터 송수신 과정

사용자가 다른 컴퓨터로 데이터를 요청한다면 어떤 일이 일어날까?

애플리케이션 계층 - 전송 계층 - 인터넷 계층 - 링크 계층을 순서대로 내려가면서 데이터가 캡슐화된다. 캡슐화는 원본 데이터에 각 계층의 헤더를 계속 붙여나가는 과정이다. 전송 계층에서 TCP(UDP) 헤더가 붙어 세그먼트(데이터그램)가 되고, 인터넷 계층에서 IP 헤더가 붙어 패킷, 링크 계층에서 이더넷 헤더가 붙어서 프레임이 된다. 수신 컴퓨터에서는 이런 캡슐화 과정을 역으로 진행하는 비캡슐화 과정이 진행된다. 

위에서 말한 세그먼트, 패킷, 프레임 등을 PDU라고 한다. 어플리케이션 계층은 메세지라고 하고, 문자열로 이루어져 있다. 
